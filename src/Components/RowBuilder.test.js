import React from 'react';
import { render, fireEvent, waitFor, screen } from '@testing-library/react';
import { MockedProvider } from '@apollo/client/testing';
import { EDIT_MATCH } from '../operations/mutations';
import '@testing-library/jest-dom';
import { RowBuilder } from './TableComponents/RowBuilder';

const mutationMock = [
  {
    request: {
      query: EDIT_MATCH,
      variables: {
        input: {
          sourceHitId: '1',
          status: 'IN_REVIEW', // Expected change
          justification: 'Initial justification',
        },
      },
    },
    result: {
      data: { acknowledgeHits: { clientMutationId: '123' } },
    },
  },
];

describe('RowBuilder Tests', () => {
  const mockData = {
    id: '1',
    justification: 'Initial justification',
    status: 'NOT_REVIEWED',
    scanDate: '2021-07-21T00:00:00.000Z',
  };
  const columnNames = {
    scanDate: 'Dates matched',
    matchedStatus: 'Match status',
    note: 'Note',
  };

  it('renders correctly', async () => {
    render(
      <MockedProvider>
        <table>
          <tbody>
            <tr>
              <RowBuilder data={mockData} columnNames={columnNames} />
            </tr>
          </tbody>
        </table>
      </MockedProvider>
    );

    const inputs = await screen.findAllByDisplayValue(/initial justification/i);
    expect(inputs.length).toBe(2);
    expect(inputs[0]).toBeInTheDocument();
  });

  it('handles dropdown change correctly', async () => {
    render(
      <MockedProvider mocks={mutationMock} addTypename={false}>
        <table>
          <tbody>
            <tr>
              <RowBuilder data={mockData} columnNames={columnNames} />
            </tr>
          </tbody>
        </table>
      </MockedProvider>
    );

    const dropdownTrigger = screen.getByLabelText('MenuToggle');
    fireEvent.click(dropdownTrigger);
    const menuItem = screen.getByLabelText('In review');
    fireEvent.click(menuItem);

    // Wait for the mutation to be processed and for the UI to update
    await waitFor(() => {
      expect(screen.getByText(/In review/i)).toBeInTheDocument();
    });
  });
});
