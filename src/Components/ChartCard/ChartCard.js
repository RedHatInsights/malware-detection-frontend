import './ChartCard.scss';

import { Card, CardBody } from '@patternfly/react-core/dist/esm/components/Card';
import { Chart, ChartAxis, ChartBar, ChartVoronoiContainer } from '@patternfly/react-charts/dist/esm/components/';
import { gqlProps, strong } from '../Common';

import Loading from '../../Components/Loading/Loading';
import NumberDescription from '../NumberDescription/NumberDescription';
import React from 'react';
import messages from '../../Messages';
import { useIntl } from 'react-intl';

const ChartCard = ({ sysStats, chartStats }) => {
    const intl = useIntl();
    const { data: sysStatsData, loading: sysStatsLoading } = sysStats;
    const { data: chartStatsData, loading: chartStatsLoading } = chartStats;
    const maxYAxisValue = (hostScanData) => {
        let maxHostScanCount = 0;
        if (hostScanData) {
            maxHostScanCount = Math.max(...hostScanData.map(item => item.hostScanCount));
        }

        // min height of our Y axis is 4, because below that the chart uses fractional values, eg 0.5, 1.0, 1.5, etc
        return maxHostScanCount < 4 ? 4 : maxHostScanCount;
    };

    const chartTransform = (data) => data.map(item => {
        const date = new Date(item.day);
        // eslint-disable-next-line no-unused-vars
        const [_weekday, month, day] = `${date}`.split(' ');

        return { name: 'Systems scanned', date, x: `${month} ${day}`, y: Number(item.hostScanCount) };
    });

    return <Card className='ins-l-chartCard'>
        <CardBody>
            <React.Fragment>
                {sysStatsLoading ? <Loading /> : <NumberDescription
                    data={sysStatsData?.hostScans?.totalCount}
                    dataSize='md'
                    description={intl.formatMessage(messages.analysisRunAcross,
                        {
                            hosts: sysStatsData?.hosts?.totalCount,
                            matches: sysStatsData?.ruleStats?.matchedCount,
                            strong: (str) => strong(str)
                        })}
                    layout='horizontal'
                />}
                {chartStatsLoading ? <Loading /> :
                    <div className='ins-l-chartContainer'>
                        <Chart
                            ariaDesc='Number of recent system scans'
                            ariaTitle='Number of recent system scans'
                            containerComponent={<ChartVoronoiContainer
                                labels={({ datum }) => `${datum.y} ${datum.name.toLowerCase()} on ${datum.x}`} constrainToVisibleArea />}
                            domainPadding={{ x: [30, 25] }}
                            height={300}
                            width={550}
                        >
                            <ChartAxis
                                dependentAxis
                                domain={[0, maxYAxisValue(chartStatsData?.timeSeriesStatsList)]}
                                tickFormat={t=>parseInt(t)}
                            />
                            <ChartAxis crossAxis />
                            <ChartBar data={chartTransform(chartStatsData.timeSeriesStatsList)} />
                        </Chart>
                    </div>}
            </React.Fragment>

        </CardBody>
    </Card>;
};

ChartCard.propTypes = gqlProps;

export default ChartCard;
