import React from 'react';
import { BrowserRouter as Router } from 'react-router-dom';
import { render, screen, waitFor, within } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { IntlProvider } from 'react-intl';
import { MockedProvider } from '@apollo/client/testing';
import { GET_HITS_TABLE } from '../../../operations/queries';
import '@testing-library/jest-dom';

import SigDetailsTable from '../SigDetailsTable';
import {
  mockSigDetailsGroupData,
  mockSigDetailsTableData,
  mockSigHitsList,
  sigDetailsTableMockRequestDefault,
  sigDetailsTableMockRequestStatusNotReviewed,
  sigDetailsTableMockRequestWorkspace1,
  sigDetailsTableMockRequestDisplayNamei,
  sigDetailsTableWorkspaceMockRequestDefault,
  sigDetailsTableWorkspaceMockRequestStatusNotReviewed,
  sigDetailsTableWorkspaceMockRequestWorkspace1,
  sigDetailsTableWorkspaceMockRequestDisplayNamei,
} from './sigDetailsTable.fixtures';

jest.mock('@unleash/proxy-client-react', () => ({
  ...jest.requireActual('@unleash/proxy-client-react'),
  useFlag: () => true,
  useFlagsStatus: () => ({ flagsReady: true }),
}));

describe('SigDetailsTable', () => {
  beforeEach(() => {
    jest.mock(
      '@redhat-cloud-services/frontend-components-utilities/RBACHook',
      () => ({
        esModule: true,
        usePermissions: () => ({ hasAccess: true, isLoading: false }),
      })
    );
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  it('should render New matches column', async () => {
    const mocks = [
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
    ];

    render(
      <MockedProvider mocks={mocks} addTypename={false}>
        <IntlProvider locale="en">
          <Router>
            <SigDetailsTable
              ruleName="bingo bango bongo"
              affectedCount={1}
              isEmptyAccount={false}
            />
          </Router>
        </IntlProvider>
      </MockedProvider>
    );

    expect(
      screen.getByRole('columnheader', {
        name: /new matches/i,
      })
    ).toBeVisible();
  });

  it('should render new match data on system row expansion', async () => {
    const mocks = [
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
      {
        request: {
          query: GET_HITS_TABLE,
          variables: {
            hostId: '94879e85-021c-491b-ab67-e1b9e634ab80',
            ruleName: 'bingo bango bongo',
          },
        },
        result: mockSigHitsList,
      },
    ];

    render(
      <MockedProvider mocks={mocks} addTypename={false}>
        <IntlProvider locale="en">
          <Router>
            <SigDetailsTable
              ruleName="bingo bango bongo"
              affectedCount={1}
              isEmptyAccount={false}
            />
          </Router>
        </IntlProvider>
      </MockedProvider>
    );

    await waitFor(() => {
      expect(
        screen.getByRole('row', {
          name: /i dont want to set the world on fire n\/a rhel 8\.0 04 jul 2024 1 1/i,
        })
      ).toBeVisible();
    });

    const row = screen.getByRole('row', {
      name: /i dont want to set the world on fire n\/a rhel 8\.0 04 jul 2024 1 1/i,
    });

    await userEvent.click(
      within(row).getByRole('button', {
        name: /details/i,
      })
    );

    await waitFor(() => {
      expect(screen.getByText('04 July 2024')).toBeVisible();
    });
  });

  it('should handle status filter', async () => {
    const mocks = [
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
      {
        request: sigDetailsTableMockRequestStatusNotReviewed,
        result: { data: { rulesList: [] } },
      },
      {
        request: sigDetailsTableWorkspaceMockRequestStatusNotReviewed,
        result: mockSigDetailsGroupData,
      },
      {
        request: sigDetailsTableMockRequestDefault,
        result: { data: { rulesList: [] } },
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
    ];

    render(
      <MockedProvider mocks={mocks} addTypename={false}>
        <IntlProvider locale="en">
          <Router>
            <SigDetailsTable
              ruleName="bingo bango bongo"
              affectedCount={1}
              isEmptyAccount={false}
            />
          </Router>
        </IntlProvider>
      </MockedProvider>
    );

    await userEvent.click(
      screen.getByRole('button', {
        name: /conditional filter toggle/i,
      })
    );

    await userEvent.click(
      screen.getByRole('menuitem', {
        name: /status/i,
      })
    );

    await userEvent.click(
      screen.getByRole('button', {
        name: /options menu/i,
      })
    );

    await userEvent.click(
      screen.getByRole('checkbox', {
        name: /not reviewed/i,
      })
    );

    await userEvent.click(
      screen.getByRole('button', {
        name: /options menu/i,
      })
    );

    expect(
      screen.getByRole('button', {
        name: /close not reviewed/i,
      })
    ).toBeVisible();

    await userEvent.click(
      screen.getByRole('button', {
        name: /close not reviewed/i,
      })
    );

    expect(
      screen.queryAllByRole('button', {
        name: /close not reviewed/i,
      })
    ).toHaveLength(0);
  });

  it('should render disabled actions column', async () => {
    jest.mock(
      '@redhat-cloud-services/frontend-components-utilities/RBACHook',
      () => ({
        esModule: true,
        usePermissions: () => ({ hasAccess: true, isLoading: false }),
      })
    );

    const mocks = [
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
    ];

    render(
      <MockedProvider mocks={mocks} addTypename={false}>
        <IntlProvider locale="en">
          <Router>
            <SigDetailsTable
              ruleName="bingo bango bongo"
              affectedCount={1}
              isEmptyAccount={false}
            />
          </Router>
        </IntlProvider>
      </MockedProvider>
    );

    await waitFor(() => {
      expect(
        screen.getByRole('row', {
          name: /i dont want to set the world on fire n\/a rhel 8\.0 04 jul 2024 1 1/i,
        })
      ).toBeVisible();
    });

    await userEvent.click(
      screen.getByRole('button', {
        name: /kebab dropdown toggle/i,
      })
    );

    expect(
      screen.getByRole('menuitem', {
        name: /delete matches/i,
      })
    ).toBeDisabled();
  });

  it('should render 0 new matches without BellIcon', async () => {
    const mocks = [
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
    ];

    render(
      <MockedProvider mocks={mocks} addTypename={false}>
        <IntlProvider locale="en">
          <Router>
            <SigDetailsTable
              ruleName="bingo bango bongo"
              affectedCount={1}
              isEmptyAccount={false}
            />
          </Router>
        </IntlProvider>
      </MockedProvider>
    );

    await waitFor(() => {
      expect(
        screen.getByRole('row', {
          name: /i dont want to set the world on fire n\/a rhel 8\.0 04 jul 2024 1 1/i,
        })
      ).toBeVisible();
    });

    const bellIcon = screen.getAllByTestId('new-matches-bell-icon');

    expect(bellIcon).toHaveLength(1);
  });

  it('should apply workspace filter', async () => {
    const mocks = [
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
      {
        request: sigDetailsTableMockRequestWorkspace1,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestWorkspace1,
        result: mockSigDetailsGroupData,
      },
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
    ];

    render(
      <MockedProvider mocks={mocks} addTypename={false}>
        <IntlProvider locale="en">
          <Router>
            <SigDetailsTable
              ruleName="bingo bango bongo"
              affectedCount={1}
              isEmptyAccount={false}
            />
          </Router>
        </IntlProvider>
      </MockedProvider>
    );

    await waitFor(() => {
      expect(
        screen.getByRole('row', {
          name: /i dont want to set the world on fire n\/a rhel 8\.0 04 jul 2024 1 1/i,
        })
      ).toBeVisible();
    });

    await userEvent.click(
      screen.getByRole('button', {
        name: /conditional filter toggle/i,
      })
    );

    await userEvent.click(
      screen.getByRole('menuitem', {
        name: /workspace/i,
      })
    );

    await userEvent.click(
      screen.getByRole('button', {
        name: /options menu/i,
      })
    );

    await userEvent.click(
      screen.getByRole('checkbox', {
        name: /workspace1/i,
      })
    );

    expect(
      screen.getByRole('button', {
        name: /close workspace1/i,
      })
    ).toBeVisible();

    await userEvent.click(
      screen.getByRole('button', {
        name: /close workspace1/i,
      })
    );
  });

  it('should apply text filter', async () => {
    const mocks = [
      {
        request: sigDetailsTableMockRequestDefault,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDefault,
        result: mockSigDetailsGroupData,
      },
      {
        request: sigDetailsTableMockRequestDisplayNamei,
        result: mockSigDetailsTableData,
      },
      {
        request: sigDetailsTableWorkspaceMockRequestDisplayNamei,
        result: mockSigDetailsGroupData,
      },
    ];

    render(
      <MockedProvider mocks={mocks} addTypename={false}>
        <IntlProvider locale="en">
          <Router>
            <SigDetailsTable
              ruleName="bingo bango bongo"
              affectedCount={1}
              isEmptyAccount={false}
            />
          </Router>
        </IntlProvider>
      </MockedProvider>
    );

    await waitFor(() => {
      expect(
        screen.getByRole('row', {
          name: /i dont want to set the world on fire n\/a rhel 8\.0 04 jul 2024 1 1/i,
        })
      ).toBeVisible();
    });

    await userEvent.type(
      screen.getByRole('textbox', {
        name: /text input/i,
      }),
      'i'
    );
  });
});
