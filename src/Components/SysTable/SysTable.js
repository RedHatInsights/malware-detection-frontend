/* eslint-disable no-unused-vars */
import './SysTable.scss';

import React, { useContext, useRef } from 'react';
import {
    cellWidth,
    sortable
} from '@patternfly/react-table/dist/esm/components/Table/index';

import {
    useFetchSystems,
    useInventoryUtilities,
    buildApiFilters
} from './hooks';
import { defaultOnLoad } from './constants';

import { DateFormat } from '@redhat-cloud-services/frontend-components/DateFormat';
import { InventoryTable } from '@redhat-cloud-services/frontend-components/Inventory';
import { GET_SYSTEM_TABLE } from '../../operations/queries';
import { Link } from 'react-router-dom';
import MessageState from '../MessageState/MessageState';
import { SearchIcon } from '@patternfly/react-icons/dist/esm/icons/search-icon';
import StatusLabel from '../StatusLabel/StatusLabel';
import { Tooltip } from '@patternfly/react-core/dist/esm/components/Tooltip/Tooltip';
import { Spinner } from '@patternfly/react-core';
import { gqlProps } from '../Common';
import messages from '../../Messages';
import { totalMatchesTitle } from '../Common';
import { useIntl } from 'react-intl';
import { RegistryContext } from '../../store';

const SysTable = () => {
    const inventory = useRef(null);
    const intl = useIntl();
    const { getRegistry } = useContext(RegistryContext);

    const columns = [
        {
            title: intl.formatMessage(messages.name),
            transforms: [cellWidth(45), sortable],
            key: 'displayName',
            sortBy: ['DISPLAY_NAME'],
            renderFunc: (displayName) => <Link to={`/systems/${displayName}`}>{displayName}</Link>
        },
        // {
        //     title: 'Tags',
        //     key: 'tags',
        //     props: { width: 10, isStatic: true }
        // },
        {
            title: intl.formatMessage(messages.lastStatus),
            transforms: [sortable, cellWidth(10)],
            key: 'hasMatch',
            sortBy: ['HAS_MATCH'],
            renderFunc: (hasMatch, id, row) => <StatusLabel isDisabled={row.isDisabled} hasMatch={hasMatch} displayMatch />
        },
        {
            title: intl.formatMessage(messages.matched),
            transforms: [sortable, cellWidth(10)],
            key: 'lastMatchDate',
            sortBy: ['LAST_MATCH_DATE'],
            renderFunc: (lastMatchDate) =>
                lastMatchDate ?
                    <Tooltip content={<DateFormat date={new Date(lastMatchDate)} type='exact' />}>
                        <span><DateFormat date={new Date(lastMatchDate)} type='onlyDate' /></span>
                    </Tooltip>
                    : <Tooltip content={intl.formatMessage(messages.noHostHas)}>
                        <span>{intl.formatMessage(messages.never)}</span>
                    </Tooltip>
        },
        {
            title: <span>{totalMatchesTitle({ tooltip: intl.formatMessage(messages.totalMatchesNote),
                title: intl.formatMessage(messages.totalMatches) })}</span>,
            transforms: [sortable, cellWidth(15)],
            key: 'totalMatches',
            sortBy: ['TOTAL_MATCHES'],
            renderFunc: (totalMatches, id, row) => <Link to={`/systems/${row.displayName}`}>{totalMatches?.toLocaleString()}</Link>
        },
        {
            title: intl.formatMessage(messages.lastScan),
            transforms: [sortable, cellWidth(10)],
            key: 'lastScanDate',
            sortBy: ['LAST_SCAN_DATE'],
            renderFunc: (lastScanDate) =>
                <Tooltip content={<DateFormat date={new Date(lastScanDate)} type='exact' />}>
                    <span><DateFormat date={new Date(lastScanDate)} /></span>
                </Tooltip>

        }
    ];

    useInventoryUtilities(inventory, [], []);

    const fetchSystems = useFetchSystems({
        query: GET_SYSTEM_TABLE
    });

    const mergedColumns = (defaultColumns) =>
        columns.map((column) => {
            const isStringCol = typeof column === 'string';
            const key = isStringCol ? column : column.key;
            const defaultColumn = defaultColumns.find(
                (defaultCol) => defaultCol.key === key
            );
            return {
                ...defaultColumn,
                ...(isStringCol ? { key: column } : column),
                props: {
                    ...defaultColumn?.props,
                    ...column?.props
                }
            };
        });

    // useEffect(() => {
    //     const rowBuilder = data => data?.hostsList?.flatMap((data, key) => ({
    //         rowId: key,
    //         cells: [
    //             { title: <Link to={`/systems/${data.displayName}`}>{data.displayName}</Link> },
    //             { title: <StatusLabel isDisabled={data.isDisabled} hasMatch={data.hasMatch} displayMatch /> },
    //             {
    //                 title: data.lastMatchDate ?
    //                     <Tooltip content={<DateFormat date={new Date(data.lastMatchDate)} type='exact' />}>
    //                         <span><DateFormat date={new Date(data.lastMatchDate)} type='onlyDate' /></span>
    //                     </Tooltip>
    //                     : <Tooltip content={intl.formatMessage(messages.noHostHas)}>
    //                         <span>{intl.formatMessage(messages.never)}</span>
    //                     </Tooltip>
    //             },
    //             { title: <Link to={`/systems/${data.displayName}`}>{data.totalMatches?.toLocaleString()}</Link> },
    //             { title: <Tooltip content={<DateFormat date={new Date(data.lastScanDate)} type='exact' />}>
    //                 <span><DateFormat date={new Date(data.lastScanDate)} /></span>
    //             </Tooltip> }

    //         ]
    //     }));

    const appendDirection = (attributes, direction) =>
        attributes.map((attribute) => `${attribute}_${direction}`);

    const findColumnByKey = (key) =>
        (columns || []).find((column) => column.key === key);

    return <React.Fragment>
        <InventoryTable
            isFullView
            autoRefresh
            initialLoading
            hideFilters={{ all: true, name: false, tags: true }}
            columns={mergedColumns}
            // TODO: enable when tag filtering is ready on BE
            // showTags
            ref={inventory}
            fallback={<Spinner />}
            onLoad={defaultOnLoad(columns, getRegistry)}
            getEntities={async (
                _ids,
                { page = 1, per_page: perPage, orderBy, orderDirection, filters }
            ) => {
                const sortableColumn = findColumnByKey(orderBy);
                const sortBy =
                sortableColumn && sortableColumn.sortBy
                    ? appendDirection(sortableColumn.sortBy, orderDirection)
                    : undefined;
                const filterForApi = buildApiFilters(filters);
                const limit = perPage;
                const offset = page * perPage - perPage;

                const fetchedEntities = await fetchSystems(limit, offset, {
                    ...filterForApi,
                    orderBy: sortBy
                });
                const {
                    entities,
                    meta: { totalCount }
                } = fetchedEntities || {};

                return {
                    results: entities.map((entity) => ({
                        ...entity
                    })),
                    orderBy,
                    orderDirection,
                    total: totalCount
                };
            }}
            tableProps={{
                canSelectAll: false,
                className: 'sysTable',
                isStickyHeader: true
            }}
            noSystemsTable={<MessageState className='pf-c-card' icon={SearchIcon} variant='large' title={intl.formatMessage(messages.noResults)}
                text={intl.formatMessage(messages.noResultsMatch)} />}
        />
    </React.Fragment>;
};

SysTable.propTypes = gqlProps;

export default SysTable;
