import { GET_SIGNATURE_PAGE, GET_TIME_SERIES_STATS } from '../../operations/queries';
import { Grid, GridItem } from '@patternfly/react-core/dist/esm/layouts/Grid/index';
import React, { Suspense, lazy, useEffect } from 'react';
import Loading from '../../Components/Loading/Loading';
import { Main } from '@redhat-cloud-services/frontend-components/Main';
import { PageHeader, PageHeaderTitle } from '@redhat-cloud-services/frontend-components/PageHeader';
import messages from '../../Messages';
import { useIntl } from 'react-intl';
import { useQuery } from '@apollo/client';
import EmptyAccount from '../../Components/SharedComponents/EmptyAccount';
import { globalFilters, hasMalware } from '../../store/cache';
import { Alert } from '@patternfly/react-core';
import { useChrome } from '@redhat-cloud-services/frontend-components/useChrome';

const SysTable = lazy(() => import(/* webpackChunkName: 'SigTable' */ '../../Components/SysTable/SysTable'));
const StatusCard = lazy(() => import(/* webpackChunkName: 'StatusCard' */ '../../Components/StatusCard/StatusCard'));
const ChartCard = lazy(() => import(/* webpackChunkName: 'ChartCard' */ '../../Components/ChartCard/ChartCard'));

const Systems = () => {
    const intl = useIntl();
    const sigPageData = useQuery(GET_SIGNATURE_PAGE);
    const chartCmpData = useQuery(GET_TIME_SERIES_STATS);
    const chrome = useChrome();
    useEffect(() => {
        chrome.updateDocumentTitle(`Systems - Malware | RHEL`);
    }, [chrome]);

    return <React.Fragment>
        <PageHeader>
            <PageHeaderTitle title={intl.formatMessage(messages.systems)} />
            {hasMalware() &&
                <Alert
                    isInline
                    variant="danger"
                    ouiaId="WeDetectedMalware"
                    title={intl.formatMessage(messages.weDetected)}
                    className="pf-u-mt-md"
                />
            }
        </PageHeader>
        <Main>
            {(sigPageData.data?.hosts?.totalCount === 0 && !globalFilters())
                ? <EmptyAccount message={intl.formatMessage(messages.emptyAccountTableBody)} />
                : (<Grid hasGutter>
                    <GridItem lg={6} md={5} sm={12}>
                        <Suspense fallback={<Loading />}><StatusCard {...{ noSigData: true, ...sigPageData }} noSigData /></Suspense>
                    </GridItem>
                    <GridItem lg={6} md={7} sm={12}>
                        <Suspense fallback={<Loading />}><ChartCard sysStats={sigPageData} chartStats={chartCmpData} /></Suspense>
                    </GridItem>
                    <GridItem span={12}>
                        <Suspense fallback={<Loading />}><SysTable /></Suspense>
                    </GridItem>
                </Grid>)
            }
        </Main>
    </React.Fragment>;
};

export default Systems;
