import React, { useEffect } from 'react';
import { useIntl } from 'react-intl';
import { useQuery } from '@apollo/client';
import { Alert, Grid, GridItem } from '@patternfly/react-core';
import { Main } from '@redhat-cloud-services/frontend-components/Main';
import {
  PageHeader,
  PageHeaderTitle,
} from '@redhat-cloud-services/frontend-components/PageHeader';
import { useChrome } from '@redhat-cloud-services/frontend-components/useChrome';
import {
  GET_SIGNATURE_PAGE,
  GET_TIME_SERIES_STATS,
} from '../../operations/queries';
import messages from '../../Messages';
import EmptyAccount from '../../Components/SharedComponents/EmptyAccount';
import { globalFilters, hasMalware } from '../../store/cache';
import SysTable from '../../Components/SysTable/SysTable';
import StatusCard from '../../Components/StatusCard/StatusCard';
import ChartCard from '../../Components/ChartCard/ChartCard';

const Systems = () => {
  const intl = useIntl();
  const sigPageData = useQuery(GET_SIGNATURE_PAGE);
  const chartCmpData = useQuery(GET_TIME_SERIES_STATS);
  const chrome = useChrome();
  useEffect(() => {
    chrome.updateDocumentTitle(`Systems - Malware`);
  }, [chrome]);

  return (
    <React.Fragment>
      <PageHeader>
        <PageHeaderTitle title={intl.formatMessage(messages.systems)} />
        {hasMalware() && (
          <Alert
            isInline
            variant="danger"
            ouiaId="WeDetectedMalware"
            title={intl.formatMessage(messages.weDetected)}
            className="pf-u-mt-md"
          />
        )}
      </PageHeader>
      <Main>
        {sigPageData.data?.hosts?.totalCount === 0 && !globalFilters() ? (
          <EmptyAccount
            message={intl.formatMessage(messages.emptyAccountTableBody)}
          />
        ) : (
          <Grid hasGutter>
            <GridItem lg={6} md={5} sm={12}>
              <StatusCard {...{ noSigData: true, ...sigPageData }} noSigData />
            </GridItem>
            <GridItem lg={6} md={7} sm={12}>
              <ChartCard sysStats={sigPageData} chartStats={chartCmpData} />
            </GridItem>
            <GridItem span={12}>
              <SysTable />
            </GridItem>
          </Grid>
        )}
      </Main>
    </React.Fragment>
  );
};

export default Systems;
