import './Details.scss';

import { ExpandableSection, Grid, GridItem } from '@patternfly/react-core';
import { Title, TitleSizes } from '@patternfly/react-core/dist/esm/components/Title';
import Breadcrumb from '../../Components/Breadcrumb/Breadcrumb';
import CodeEditor from '../../Components/CodeEditor/CodeEditor';
import { DateFormat } from '@redhat-cloud-services/frontend-components/DateFormat';
import { GET_SIGNATURE_DETAILS_PAGE } from '../../operations/queries';
import Loading from '../../Components/Loading/Loading';
import { Main } from '@redhat-cloud-services/frontend-components/Main';
import { PageHeader } from '@redhat-cloud-services/frontend-components/PageHeader';
import React from 'react';
import SigDetailsTable from '../../Components/SigDetailsTable/SigDetailsTable';
import StatusLabel from '../../Components/StatusLabel/StatusLabel';
import { isBeta } from '../../Components/Common';
import messages from '../../Messages';
import { useIntl } from 'react-intl';
import { useParams } from 'react-router-dom';
import { useQuery } from '@apollo/client';

const Details = () => {
    const intl = useIntl();
    const [isCodeEditorEnabled] = React.useState(false);
    const { id: sigId } = useParams();
    const breadcrumbs = [{ name: intl.formatMessage(messages.malwareDetectionSignatures),
        to: `${isBeta()}/insights/malware` }, { name: sigId, to: '#' }];
    const { data, loading } = useQuery(GET_SIGNATURE_DETAILS_PAGE, {
        variables: { ruleName: sigId  }
    });
    const sigDetailsData = data?.rulesList[0];
    const sigMetadata = sigDetailsData?.metadata;
    const references = sigMetadata?.references || [];
    const xfti_references = sigMetadata?.xfti_references || [];
    const dataNotAvailable = intl.formatMessage(messages.dataNotAvailable);
    const detailBlock = (title, detail) => <React.Fragment>
        <p className='ins-l-detailBlockHeader'>{title}</p>
        <p>{detail || dataNotAvailable}</p>
    </React.Fragment>;
    const referenceLink = (referenceLinkData) => <p>
        <a rel="noopener noreferrer" target="_blank" href={referenceLinkData}>{referenceLinkData}</a>
    </p>;
    const referenceGridItem = (title, links) => <React.Fragment>
        {links.length > 1 ?
            <ExpandableSection toggleText={intl.formatMessage(title)} isIndented>
                {links.map((link) => referenceLink(link))}
            </ExpandableSection>
            :
            <div className='ins-l-referenceLink'>
                {detailBlock(intl.formatMessage(title), referenceLink(links))}
            </div>}
    </React.Fragment>;

    return <React.Fragment>
        <PageHeader>
            <Breadcrumb items={breadcrumbs} />
            <Grid hasGutter>
                <GridItem md={12} sm={12}>
                    <Title headingLevel='h1' size={TitleSizes['3xl']} >{sigId}</Title>
                </GridItem>

                {isCodeEditorEnabled && (<GridItem md={7} sm={12}>
                    { sigDetailsData && <CodeEditor height='250px' code={sigDetailsData.rawRule} isReadOnly isDownloadEnabled isCopyEnabled />}
                </GridItem>)}

                {loading ? <Loading /> :
                    <GridItem md={isCodeEditorEnabled && 5 || 12} sm={12}>
                        <Grid hasGutter>
                            <GridItem xl2={isCodeEditorEnabled && 6 || 1} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.lastmatch), sigDetailsData?.lastMatchDate ?
                                    <DateFormat date={new Date(sigDetailsData.lastMatchDate)} type="onlyDate" />
                                    : intl.formatMessage(messages.never))}
                            </GridItem>
                            <GridItem xl2={isCodeEditorEnabled && 6 || 1} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.hostmatch),
                                    <span>{`${sigDetailsData?.affectedHosts?.totalCount}/${data?.hosts?.totalCount}`}</span>)}
                            </GridItem>
                            {isCodeEditorEnabled && <GridItem xl2={6} xl={6} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.description), sigMetadata?.description)}
                            </GridItem>}
                            <GridItem xl2={isCodeEditorEnabled && 6 || 1} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.enablement), sigDetailsData && <StatusLabel {...sigDetailsData} />)}
                            </GridItem>
                            <GridItem xl2={isCodeEditorEnabled && 6 || 2} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.author), sigMetadata?.author)}
                            </GridItem>
                            {!isCodeEditorEnabled && <GridItem xl2={7} xl={3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.description), sigMetadata?.description)}
                            </GridItem>}
                            <GridItem xl2={isCodeEditorEnabled && 6 || 1} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.ruleCategory), sigMetadata?.rule_category)}
                            </GridItem>
                            <GridItem xl2={isCodeEditorEnabled && 6 || 1} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.threatType), sigMetadata?.threat_type)}
                            </GridItem>
                            <GridItem xl2={isCodeEditorEnabled && 6 || 2} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {detailBlock(intl.formatMessage(messages.ruleIntendedUsage), sigMetadata?.usage)}
                            </GridItem>
                            <GridItem xl2={isCodeEditorEnabled && 6 || 7} xl={isCodeEditorEnabled && 6 || 3} md={6} xs={12}>
                                {xfti_references.length > 0 &&
                                    referenceGridItem(
                                        xfti_references.length > 1 ? messages.ruleAuthorReferences : messages.ruleAuthorReference,
                                        xfti_references)}
                                {references.length > 0 &&
                                    referenceGridItem(
                                        references.length > 1 ? messages.ruleBackgroundReferences : messages.ruleBackgroundReference,
                                        references)}
                                {!references.length && !xfti_references.length &&
                                    detailBlock(intl.formatMessage(messages.ruleReferences), dataNotAvailable)}
                            </GridItem>
                        </Grid>
                    </GridItem>
                }
            </Grid>
        </PageHeader>
        <Main>
            <Title className='ins-l-tableBlockHeader' headingLevel='h1' size={TitleSizes['3xl']}>
                {intl.formatMessage(messages.affectedHosts)}
            </Title>
            <SigDetailsTable
                ruleName={sigId}
                isEmptyAccount={data?.hosts?.totalCount === 0}
                affectedCount={sigDetailsData?.affectedHosts?.totalCount}
            />
        </Main>
    </React.Fragment>;
};

export default Details;
