/* eslint-disable no-console */
import { ApolloClient, ApolloProvider, createHttpLink } from '@apollo/client';
import { NotificationsPortal, notifications } from '@redhat-cloud-services/frontend-components-notifications/';
import React, { useEffect, useMemo, useRef } from 'react';

import App from './App';
import { IntlProvider } from '@redhat-cloud-services/frontend-components-translations';
import PropTypes from 'prop-types';
import { Provider } from 'react-redux';
import { cache } from './store/cache';
import { init, RegistryContext } from './store';
import { globalFilters } from './store/cache';
import logger from 'redux-logger';
import messages from '../locales/data.json';
import { setContext } from '@apollo/client/link/context';
import { useChrome } from '@redhat-cloud-services/frontend-components/useChrome';
import Loading from './Components/Loading/Loading';

const AppEntry = ({ isDevEnvironment, connectToDevTools }) => {
    const tags = useRef();
    const storeRegistry = useMemo(() => {
        const registery = isDevEnvironment ? init(logger) : init();
        registery.register({ notifications });
        return registery;
    }, [isDevEnvironment]);
    const selectedWorkloads = useRef();
    const selectedSID = useRef();
    const chrome = useChrome();

    const globalFilterLink = setContext((_, { headers }) => ({
        headers: {
            ...headers,
            ...(tags.current?.length && { 'insights-tags': `${tags.current}` }),
            ...(selectedWorkloads.current?.SAP?.isSelected && { 'insights-sap-system': true }),
            ...(selectedWorkloads.current['Ansible Automation Platform']?.isSelected && { 'insights-ansible-system': true }),
            ...(selectedWorkloads.current['Microsoft SQL']?.isSelected && { 'insights-mssql-system': true }),
            ...(selectedSID.current?.length && { 'insights-sap-sids': `${selectedSID.current}` })
        }
    }));
    const client = useMemo(() =>  new ApolloClient({
        link: globalFilterLink.concat(createHttpLink({
            uri: '/api/malware-detection/v1/graphql'
        })),
        cache,
        connectToDevTools
    }, `${tags.current}`), [connectToDevTools, globalFilterLink]);

    useEffect(() => {
        if (chrome.globalFilterScope) {
            chrome.on('GLOBAL_FILTER_UPDATE', ({ data }) => {
                const [workloads, SID, selectedTags] =
                chrome.mapGlobalFilter?.(data, false, true) || [];
                tags.current =  selectedTags?.join(',') || '';

                selectedWorkloads.current = workloads || {};
                selectedSID.current = SID || [];

                globalFilters({ workloads, SID, selectedTags });

                client.resetStore();
            });
        }

    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [client]);

    return storeRegistry ?
        <IntlProvider locale={navigator.language.slice(0, 2)} messages={messages} onError={console.log}>
            <ApolloProvider client={client}>
                <RegistryContext.Provider value={{ getRegistry: () => storeRegistry }}>
                    <Provider store={storeRegistry.getStore()}>
                        <NotificationsPortal />
                        <App />
                    </Provider>
                </RegistryContext.Provider>
            </ApolloProvider>
        </IntlProvider>
        : <Loading/>;
};

AppEntry.propTypes = {
    isDevEnvironment: PropTypes.bool,
    connectToDevTools: PropTypes.bool
};

AppEntry.defaultProps = {
    isDevEnvironment: false,
    connectToDevTools: false
};

export default AppEntry;
